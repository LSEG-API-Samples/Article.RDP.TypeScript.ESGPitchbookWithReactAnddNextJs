!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).EDPHelper={})}(this,(function(e){"use strict";var t;!function(e){e.GET_TOKEN="GET_TOKEN",e.RETURN_TOKEN="RETURN_TOKEN",e.TOKEN_UPDATED="TOKEN_UPDATED"}(t||(t={}));var n=new(function(){function e(){this.bus=null,this.DEFAULT_TIMEOUNT_FOR_REQEUST_TOKEN=17e3,this.listener=this.listenTokenChange.bind(this),this.channel="/!crosstab/edp-helper-app",this.isNotifyTokenUpdated=!1,this.jetSubscribeCounter=0,this.debugMode=!1,this.debugMessages=[],this.jetFlowInitialized=!1,this.memoryStorage=new Map,this.busInfo={busSubScription:null,busMode:!1,busInited:!1},this.overrodeXhrOpen=!1,this.initializeJETFlow()}return e.prototype.setTokenProperty=function(e,t){this.busInfo.busMode?this.memoryStorage.set(e,t):localStorage.setItem(e,t)},e.prototype.getTokenProperty=function(e){return this.busInfo.busMode?this.memoryStorage.get(e):localStorage.getItem(e)},Object.defineProperty(e.prototype,"token",{get:function(){return this.getTokenProperty("edp-token")},set:function(e){this.setTokenProperty("edp-token",e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"validUntil",{get:function(){var e=this.getTokenProperty("edp-validUntil");return e?new Date(e):null},set:function(e){this.setTokenProperty("edp-validUntil",e.toString())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastUse",{get:function(){var e=this.getTokenProperty("edp-lastUse");return e?new Date(e):null},set:function(e){this.setTokenProperty("edp-lastUse",e.toString())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mainInstance",{get:function(){var e=this.getTokenProperty("edp-mainInstance");return e||null},set:function(e){this.setTokenProperty("edp-mainInstance",e.toString())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"edpChannel",{get:function(){var e=this.getTokenProperty("edp-channel");return e||null},set:function(e){this.setTokenProperty("edp-channel",e.toString())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"debug",{get:function(){return this.debugMode},set:function(e){this.debugMode=e,this.printConsoleMessage().print()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isReady",{get:function(){return this.appId&&this.scopes&&this.scopes.length>0},enumerable:!0,configurable:!0}),e.prototype.initializeJETFlow=function(){var e=this;if(!this.jetFlowInitialized)try{window.JET?(this.ipcInstance=window.JET,window.JET.onLoad((function(){e.printConsoleMessage().debug("[edp-helper] JET onLoad"),e.subscription=e.ipcInstance.subscribe(e.channel,e.handleReceivedMessage.bind(e),null),e.publishMessage("checkMainInstance",null),e.publishMessage("edpChannel",null),e.jetFlowInitialized=!0,e.printConsoleMessage().log("[edp-helper] JET flow initialize successfully")}))):this.printConsoleMessage().log("[edp-helper] JET is not available. Waiting for JET.onLoad...")}catch(t){this.printConsoleMessage().error("[edp-helper] Error in initializeJETFlow.",t)}},e.prototype.initBus=function(){var e=this;return new Promise((function(t,n){null!==e.bus?(console.debug("[edp-helper] Start init bus"),e.busInfo.busMode=!0,e.ipcInstance=e.bus,e.busInfo.busSubScription=e.ipcInstance.subscribe(e.channel,(function(t,n){e.handleReceivedMessage(n)})),e.publishMessage("checkMainInstance",null),e.publishMessage("edpChannel",null),e.busInfo.busInited=!0,console.log("[edp-helper] Bus initialize successfully")):console.debug("[edp-helper] No bus provided"),t()}))},e.prototype.setAutoExtendRefreshTokenPeriod=function(){var e=this,t=0;this.renewTokenTimer&&clearTimeout(this.renewTokenTimer),this.validUntil&&(t=this.validUntil.getTime()-(new Date).getTime()-3e4),this.renewTokenTimer=setTimeout((function(){e.publishMessage("lastUse",e.lastUse.toString())}),t)},e.prototype.publishMessage=function(e,t,n){void 0===n&&(n=null),this.ipcInstance&&this.ipcInstance.publish(null===n?this.channel:n,"client::"+e+"::"+t)},e.prototype.printConsoleMessage=function(){var e=this,t=this.getTimestamp(),n=function(n,i,s){void 0===s&&(s=[]);var r={method:n,timelog:t,message:i,optionalParams:s};e.debugMessages.length>100&&e.debugMessages.shift(),e.debugMessages.push(r),o()},o=function(){if(e.debug)for(;e.debugMessages.length>0;){var t=e.debugMessages.shift();console[t.method].apply(console,[t.timelog+" ",t.message].concat(t.optionalParams))}};return{log:function(e,t){n("log",e,t)},debug:function(e,t){n("debug",e,t)},warn:function(e,t){n("warn",e,t)},error:function(e,t){n("error",e,t)},print:o}},e.prototype.handleGetAccessTokenFromJET=function(e){e&&""!==e&&"null"!==e&&(this.token=e)},e.prototype.handleCheckMainInstance=function(e){e&&""!==e&&"null"!==e&&(this.mainInstance=e)},e.prototype.handleEdpChannel=function(e){e&&""!==e&&"null"!==e&&(this.edpChannel=e)},e.prototype.handleValidUntil=function(e){e&&""!==e&&"null"!==e&&(this.validUntil=new Date(e))},e.prototype.handleReceivedMessage=function(e){var t=e.split("::")[0],n=e.split("::")[1],o=e.split("::")[2];if("master"===t)switch(n){case"getAccessToken":this.handleGetAccessTokenFromJET(o);break;case"checkMainInstance":this.handleCheckMainInstance(o);break;case"edpChannel":this.handleEdpChannel(o);break;case"validUntil":this.handleValidUntil(o)}},e.prototype.getAccessTokenFromJET=function(e){var t=this;return void 0===e&&(e=this.DEFAULT_TIMEOUNT_FOR_REQEUST_TOKEN),new Promise((function(n,o){var i;if(t.ipcInstance){t.ipcInstance.unsubscribe(t.channel+"/token"),t.ipcInstance.subscribe(t.channel+"/token",(function(e,o){var s,r=(s=t.busInfo.busMode?o:e).split("::")[0],a=s.split("::")[1],c=s.split("::")[2];r&&"master"===r&&a&&"token"===a&&c&&"null"!==c&&(clearTimeout(i),t.token=c,n(t.token))}),null),t.publishMessage("requestToken",null,t.channel+"/token"),i=setTimeout((function(){o("Get access token timeout after "+e+" ms")}),e)}else console.error("[edp-helper] JET not found, cannot getAccessTokenFromJET."),o("JET not found")}))},e.prototype.getTokenFromContainer=function(e){var n=this;return void 0===e&&(e=this.DEFAULT_TIMEOUNT_FOR_REQEUST_TOKEN),new Promise((function(o,i){var s;n.ipcInstance?(n.jetSubscribeCounter++,n.listenerForGetTokenRWContainer=n.ipcInstance.subscribe("/oauth",(function(e,i){var r,a=r=n.busInfo.busMode?i:e;"string"==typeof r&&(a=JSON.parse(r)),a.action===t.RETURN_TOKEN&&a.data&&(n.jetSubscribeCounter--,0==n.jetSubscribeCounter&&n.listenerForGetTokenRWContainer.unsubscribe(),s&&clearTimeout(s),console.debug("[edp-helper] Resolve token from container"),o(a.data.authNAccessToken))})),s=setTimeout((function(){n.jetSubscribeCounter--,0==n.jetSubscribeCounter&&n.listenerForGetTokenRWContainer.unsubscribe(),o("There is no response from container")}),e),console.debug("[edp-helper] Get token from container"),n.ipcInstance.publish("/oauth",{action:t.GET_TOKEN})):o("Cannot detect JET")}))},e.prototype.SetAutoXMLHttpHeader=function(e){var t=this;this.isReady?e&&0!=e.length?(this.whitelist=e,navigator.userAgent.indexOf("TR-Electron")<0&&(this.getAccessToken().then((function(){t.setTokenForXMLHttp()})).catch((function(e){console.error("[edp-helper] Error when get token in SetAutoHeader",e)})),this.listenForTokenChange())):this.isListening&&!this.isNotifyTokenUpdated&&this.removeListenForTokenChange():console.warn("[edp-helper] Please specify appId and scopes")},e.prototype.isBusInitialized=function(){var e=this;return new Promise((function(t,n){null===e.bus||e.busInfo.busInited?t():e.initBus().then((function(){t()}))}))},e.prototype.getAccessToken=function(e){var t=this;return void 0===e&&(e=this.DEFAULT_TIMEOUNT_FOR_REQEUST_TOKEN),this.isReady?this.isBusInitialized().then((function(){return t.isWorkspace()?(console.debug("[edp-helper] Detected desktop mode."),t.getTokenFromContainer(e)):t.validUntil>new Date&&t.token&&"null"!==t.token?(t.lastUse=new Date,t.publishMessage("lastUse",t.lastUse.toString()),console.debug("[edp-helper] Return existing token."),Promise.resolve(t.token)):t.ipcInstance&&("null"===t.token||t.validUntil<new Date)?new Promise((function(n,o){t.lastUse=new Date,t.publishMessage("lastUse",t.lastUse.toString()),t.getAccessTokenFromJET(e).then((function(e){return n(e)})).catch((function(i){console.error("[edp-helper] getAccessTokenFromJET failed",i),console.debug("[edp-helper] Fallback to localStorage flow"),t.getAccessTokenFromLocalStorage(e).then((function(e){return n(e)})).catch((function(e){return console.error("[edp-helper] Get access token failed",e),o(e)}))}))})):(console.debug("[edp-helper] Get access token from localStorage"),t.getAccessTokenFromLocalStorage(e))})):(console.warn("[edp-helper] Please specify appId and scopes"),Promise.resolve("Please specify appId and scopes"))},e.prototype.getAccessTokenFromLocalStorage=function(e){var t=this;return void 0===e&&(e=this.DEFAULT_TIMEOUNT_FOR_REQEUST_TOKEN),new Promise((function(n,o){var i;return t.checkMainInstance(e).then((function(){var s=function(e){"edp-token"===e.key&&"null"!==e.newValue&&(window.removeEventListener("storage",s),clearTimeout(i),n(e.newValue))};window.addEventListener("storage",s),t.lastUse=new Date,i=setTimeout((function(){return window.removeEventListener("storage",s),o("Get access token timeout after "+e+" ms")}),e)}))}))},e.prototype.checkMainInstance=function(e){var t=this;if(void 0===e&&(e=2e3),!this.mainInstance||"null"===this.mainInstance)return console.debug("[edp-helper] No mainInstance"),Promise.resolve(!1);var n=new Promise((function(n){var o,i=function(e){if("edp-channel"===e.key&&e.newValue&&"null"!==e.newValue){var s=e.newValue.split(":"),r=s[0],a=s[1].split("->"),c=(a[0],a[1]);if(r===t.mainInstance&&"alive!"===c)return window.removeEventListener("storage",i),clearTimeout(o),console.debug("[edp-helper] mainInstance is alive!"),n(!0)}};o=setTimeout((function(){return window.removeEventListener("storage",i),console.debug("[edp-helper] No response from mainInstance"),n(!1)}),e),window.addEventListener("storage",i)}));return this.edpChannel=this.appId+":"+this.mainInstance+"->alive?",n},e.prototype.listenForTokenChange=function(){window.addEventListener("storage",this.listener),this.isListening=!0},e.prototype.removeListenForTokenChange=function(){window.removeEventListener("storage",this.listener),this.isListening=!1},e.prototype.listenTokenChange=function(e){"edp-token"===e.key&&"null"!==e.newValue&&(this.setTokenForXMLHttp(),this.isNotifyTokenUpdated&&(this.emitTokenChanged(e.newValue),this.setAutoExtendRefreshTokenPeriod()))},e.prototype.setTokenForXMLHttp=function(){if(this.lastUse=new Date,!this.overrodeXhrOpen){var e=this,t=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(n,o){var i=!1;t.apply(this,arguments),e.whitelist.forEach((function(e){o.indexOf(e)>=0&&(i=!0)})),i&&this.setRequestHeader("Authorization","Bearer "+e.token)},this.overrodeXhrOpen=!0}},e.prototype.isWorkspace=function(){return navigator.userAgent.indexOf("TR-Electron")>=0},e.prototype.enableNotifyTokenChanged=function(e){this.isNotifyTokenUpdated=e,this.isWorkspace()?this.isNotifyTokenUpdated?this.listenForTokenChangeFromRWContainer():this.removeListenForTokenChangeFromRWContainer():(this.enableRenewTokenAutomatically(e),this.isNotifyTokenUpdated?this.listenForTokenChange():this.removeListenForTokenChange())},e.prototype.enableRenewTokenAutomatically=function(e){this.isWorkspace()||(e?this.setAutoExtendRefreshTokenPeriod():this.renewTokenTimer&&clearTimeout(this.renewTokenTimer))},e.prototype.listenForTokenChangeFromRWContainer=function(){var e=this;this.ipcInstance&&(this.listenerFromRWContainer=this.ipcInstance.subscribe("/oauth",(function(n,o){var i,s=i=e.busInfo.busMode?o:n;"string"==typeof i&&(s=JSON.parse(i)),s.action===t.TOKEN_UPDATED&&e.isNotifyTokenUpdated&&s.data&&s.data.authNAccessToken&&e.emitTokenChanged(s.data.authNAccessToken)})))},e.prototype.removeListenForTokenChangeFromRWContainer=function(){this.listenerFromRWContainer&&this.listenerFromRWContainer.unsubscribe()},e.prototype.emitTokenChanged=function(e){var t=document.createEvent("CustomEvent");t.initCustomEvent("tokenChanged",!1,!1,e),window.dispatchEvent(t)},e.prototype.getTimestamp=function(){var e=new Date;function t(e){var t=""+e;return t.length<2?"0"+t:t}return"["+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())+"]"},e.prototype.clearAccessToken=function(){localStorage.removeItem("edp-token"),localStorage.removeItem("edp-validUntil")},e}());window.EDP=n,e.EDP=n,Object.defineProperty(e,"__esModule",{value:!0})}));
